<link rel="manifest" href="/dummy-magazine/manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="/dummy-magazine/icons/apple-touch-icon-180.png">

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/dummy-magazine/service-worker.js', {
        updateViaCache: 'none'
      });
      reg.update().catch(() => {});
    } catch (e) {
      console.warn('[PWA] SW register failed', e);
    }
  });
}

// optional helper: send current page assets to SW to cache in background
async function sendAssetsToSW() {
  if (!('serviceWorker' in navigator)) return;
  const reg = await navigator.serviceWorker.ready;
  const assets = new Set();
  const push = (u) => { try { assets.add(new URL(u, location.href).pathname); } catch {} };

  document.querySelectorAll(
    'link[rel="stylesheet"], link[rel="preload"][as], script[src], img[src], source[srcset], video[src], audio[src]'
  ).forEach(el => {
    if (el.href) push(el.href);
    if (el.src)  push(el.src);
    if (el.srcset) el.srcset.split(',').forEach(s => push(s.trim().split(' ')[0]));
  });

  assets.add(location.pathname);
  assets.add('/dummy-magazine/index.html');

  reg.active?.postMessage({ type: 'PWA_ASSETS', assets: [...assets] });
}
window.addEventListener('load', sendAssetsToSW);
</script>

<style>
  #pwa-install-banner{position:fixed;left:0;right:0;bottom:0;z-index:99999;
    display:none;background:#111;color:#fff;box-shadow:0 -8px 24px rgba(0,0,0,.25)}
  #pwa-install-inner{max-width:960px;margin:0 auto;padding:12px 16px;display:flex;gap:12px;align-items:center}
  #pwa-install-banner img{height:40px;width:40px;border-radius:8px;flex:none}
  #pwa-install-text{flex:1;line-height:1.3}
  #pwa-install-actions{display:flex;gap:8px}
  #pwa-install-actions button{background:#fff;color:#111;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  #pwa-install-close{background:transparent;color:#fff;border:1px solid #fff;opacity:.7}
  @media (prefers-color-scheme:light){
    #pwa-install-banner{background:#fff;color:#111;border-top:1px solid #e5e5e5}
    #pwa-install-actions button{background:#111;color:#fff}
    #pwa-install-close{color:#111;border-color:#111}
  }
</style>

<div id="pwa-install-banner" role="dialog" aria-live="polite" aria-label="Install app">
  <div id="pwa-install-inner">
    <!-- Use promo if you add one; otherwise fall back to your 192 icon -->
    <img id="pwa-install-icon" src="/dummy-magazine/icons/icon-192.png" alt="" />
    <div id="pwa-install-text"></div>
    <div id="pwa-install-actions">
      <button id="pwa-install-cta">Install</button>
      <button id="pwa-install-close" aria-label="Dismiss">Close</button>
    </div>
  </div>
</div>

<script>
(function(){
  const banner = document.getElementById('pwa-install-banner');
  const text   = document.getElementById('pwa-install-text');
  const ctaBtn = document.getElementById('pwa-install-cta');
  const closeBtn = document.getElementById('pwa-install-close');
  const iconEl = document.getElementById('pwa-install-icon');

  // Optional: if you add a promo graphic, switch it here:
  // iconEl.src = '/dummy-magazine/icons/pwa-promo.png';

  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  if (isStandalone) return; // already "installed"

  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    // Android/desktop
    e.preventDefault();
    deferredPrompt = e;
    text.textContent = 'Install this app for quick, offline access.';
    ctaBtn.textContent = 'Install';
    ctaBtn.onclick = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } finally {
        deferredPrompt = null;
        banner.style.display = 'none';
        localStorage.setItem('pwaInstallDismissed', '1');
      }
    };
    showOnce();
  });

  // iOS fallback banner
  if (isIOS) {
    text.textContent = 'On iOS: tap Share, then “Add to Home Screen” to install.';
    ctaBtn.textContent = 'Got it';
    ctaBtn.onclick = () => {
      banner.style.display = 'none';
      localStorage.setItem('pwaInstallDismissed', '1');
    };
    showOnce();
  }

  closeBtn.onclick = () => {
    banner.style.display = 'none';
    localStorage.setItem('pwaInstallDismissed', '1');
  };

  function showOnce(){
    if (localStorage.getItem('pwaInstallDismissed') === '1') return;
    banner.style.display = 'block';
  }
})();
</script>
